<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube API - Google Identity Services</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script async src="https://apis.google.com/js/api.js"></script>
</head>
<body>
    <h1>YouTube API - Работа с плейлистами</h1>
    <button id="auth-button">Войти в YouTube</button>
    <button id="create-playlist-button" disabled>Создать плейлист</button>
    
    <h2>Мои плейлисты</h2>
    <ul id="playlist-list"></ul>

    <script>
        const CLIENT_ID = "887427343919-s2ps1l74fgosvfdqb07b5eggkvg8pd94.apps.googleusercontent.com";
        const API_KEY = "AIzaSyDEtjKGo-foGtYWL2nvmzI0dZ_wgJVNB8I";
        const SCOPES = "https://www.googleapis.com/auth/youtube.force-ssl";

        let accessToken = '';

        function handleCredentialResponse(response) {
            const id_token = response.credential;
            console.log("ID Token:", id_token);
            
            // Получаем access token
            const payload = jwt_decode(id_token); // Используем библиотеку jwt-decode
            accessToken = payload.access_token;

            // Устанавливаем API ключ
            gapi.client.setApiKey(API_KEY);

            // Загружаем YouTube API
            gapi.client.load("youtube", "v3").then(() => {
                console.log("GAPI client loaded for API");
                getPlaylists(); // Получаем плейлисты после загрузки API
                document.getElementById('create-playlist-button').disabled = false;
            }, (err) => {
                console.error("Error loading GAPI client for API", err);
            });
        }

        function createPlaylist() {
            const request = gapi.client.youtube.playlists.insert({
                part: "snippet,status",
                resource: {
                    snippet: {
                        title: "Новый плейлист",
                        description: "Описание плейлиста"
                    },
                    status: {
                        privacyStatus: "private"  // 'public', 'private', 'unlisted'
                    }
                },
                headers: {
                    'Authorization': 'Bearer ' + accessToken // Используем токен доступа
                }
            });
            request.execute(function(response) {
                console.log("Плейлист создан:", response);
                getPlaylists(); // Обновляем список плейлистов после создания нового
            });
        }

        function getPlaylists() {
            const request = gapi.client.youtube.playlists.list({
                part: 'snippet',
                mine: true,
                headers: {
                    'Authorization': 'Bearer ' + accessToken // Используем токен доступа
                }
            });
            request.execute(function(response) {
                console.log("Playlists:", response);
                const playlists = response.items;
                const playlistList = document.getElementById('playlist-list');
                playlistList.innerHTML = ''; // Очищаем предыдущие результаты

                if (playlists.length) {
                    playlists.forEach(function(playlist) {
                        const listItem = document.createElement('li');
                        listItem.textContent = playlist.snippet.title; // Название плейлиста
                        playlistList.appendChild(listItem);
                    });
                } else {
                    playlistList.innerHTML = '<li>Плейлисты не найдены.</li>';
                }
            });
        }

        function initGoogleAuth() {
            google.accounts.id.initialize({
                client_id: CLIENT_ID,
                callback: handleCredentialResponse
            });

            google.accounts.id.renderButton(
                document.getElementById("auth-button"),
                { theme: "outline", size: "large" }  // Настройка кнопки
            );

            google.accounts.id.prompt(); // Запрос на аутентификацию
        }

        // Загружаем API и инициализируем клиент
        function gapiLoad() {
            gapi.load("client", initGoogleAuth);
        }

        window.onload = function() {
            gapiLoad(); // Вызываем функцию загрузки gapi при загрузке страницы
        };

        document.getElementById('create-playlist-button').addEventListener('click', createPlaylist);
    </script>
</body>
</html>
